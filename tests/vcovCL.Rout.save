
R version 4.2.0 (2022-04-22) -- "Vigorous Calisthenics"
Copyright (C) 2022 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library("sandwich")
> data("PetersenCL", package = "sandwich")
> m <- lm(y ~ x, data = PetersenCL)
> b <- glm((y > 0) ~ x, data = PetersenCL, family = binomial(link = "logit"))
> 
> options(digits = 4)
> 
> ## various versatile variance flavors
> vcovCL(m, cluster = ~ firm, type = "HC0", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.490e-03 -6.472e-05
x            -6.472e-05  2.559e-03
> vcovCL(m, cluster = ~ firm, type = "HC0", cadjust = FALSE)
            (Intercept)          x
(Intercept)   4.481e-03 -6.459e-05
x            -6.459e-05  2.554e-03
> vcovCL(m, cluster = ~ firm, type = "HC1", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.491e-03 -6.474e-05
x            -6.474e-05  2.560e-03
> vcovCL(m, cluster = ~ firm, type = "HC1", cadjust = FALSE)
            (Intercept)          x
(Intercept)   4.482e-03 -6.461e-05
x            -6.461e-05  2.555e-03
> vcovCL(m, cluster = ~ firm, type = "HC2", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.494e-03 -6.593e-05
x            -6.593e-05  2.568e-03
> vcovCL(m, cluster = ~ firm, type = "HC2", cadjust = FALSE)
            (Intercept)          x
(Intercept)   0.0044855 -0.0000658
x            -0.0000658  0.0025631
> vcovCL(m, cluster = ~ firm, type = "HC3", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.508e-03 -6.728e-05
x            -6.728e-05  2.582e-03
> vcovCL(m, cluster = ~ firm, type = "HC3", cadjust = FALSE)
            (Intercept)          x
(Intercept)   4.499e-03 -6.715e-05
x            -6.715e-05  2.577e-03
> 
> vcovCL(m, cluster = ~ firm + year, type = "HC0", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.232e-03 -2.845e-05
x            -2.845e-05  2.868e-03
> vcovCL(m, cluster = ~ firm + year, type = "HC0", cadjust = FALSE)
            (Intercept)          x
(Intercept)   0.0041690 -0.0000308
x            -0.0000308  0.0027515
> vcovCL(m, cluster = ~ firm + year, type = "HC1", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.233e-03 -2.845e-05
x            -2.845e-05  2.868e-03
> vcovCL(m, cluster = ~ firm + year, type = "HC1", cadjust = FALSE)
            (Intercept)          x
(Intercept)    4.17e-03 -0.0000308
x             -3.08e-05  0.0027520
> vcovCL(m, cluster = ~ firm + year, type = "HC2", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.237e-03 -2.821e-05
x            -2.821e-05  2.877e-03
> vcovCL(m, cluster = ~ firm + year, type = "HC2", cadjust = FALSE)
            (Intercept)         x
(Intercept)   0.0041738 -3.07e-05
x            -0.0000307  2.76e-03
> vcovCL(m, cluster = ~ firm + year, type = "HC3", cadjust = TRUE)
            (Intercept)          x
(Intercept)   4.312e-03 -2.504e-05
x            -2.504e-05  3.015e-03
> vcovCL(m, cluster = ~ firm + year, type = "HC3", cadjust = FALSE)
            (Intercept)          x
(Intercept)   4.242e-03 -2.798e-05
x            -2.798e-05  2.886e-03
> 
> 
> ## comparison with multiwayvcov::cluster.vcov
> if(!require("multiwayvcov")) q()
Loading required package: multiwayvcov
> all.equal(
+   vcovCL(m, cluster = ~ firm),
+   multiwayvcov::cluster.vcov(m, ~ firm)
+ )
[1] TRUE
> all.equal(
+   vcovCL(m, cluster = ~ firm + year, multi0 = TRUE),
+   multiwayvcov::cluster.vcov(m, ~ firm + year)
+ )
[1] TRUE
> all.equal(
+   vcovCL(m, cluster = ~ firm, type = "HC0", cadjust = FALSE),
+   multiwayvcov::cluster.vcov(m, ~ firm, df_correction = FALSE)
+ )
[1] TRUE
> all.equal(
+   vcovCL(m, cluster = ~ firm + year, type = "HC0", cadjust = FALSE),
+   multiwayvcov::cluster.vcov(m, ~ firm + year, df_correction = FALSE)
+ )
[1] TRUE
> 
> 
> ## comparison with BMlmSE snippet (https://github.com/kolesarm/Robust-Small-Sample-Standard-Errors,
> ## Bell-McCaffrey standard errors as described in Imbens and Kolesar 2016)
> 
> ## BMlmSE(m, clustervar = factor(PetersenCL$firm))$vcov
> bellmc1 <- matrix(c(0.0044944872570532, -6.59291186924326e-05, -6.59291186924326e-05, 0.00256823604178553), nrow = 2)
> rownames(bellmc1) <- colnames(bellmc1) <- c("(Intercept)", "x")
> 
> (bellmc2 <- vcovCL(m, cluster = ~ firm, type = "HC2"))
            (Intercept)          x
(Intercept)   4.494e-03 -6.593e-05
x            -6.593e-05  2.568e-03
> all.equal(bellmc1, bellmc2)
[1] TRUE
> 
> 
> ## comparison with Stata/MP 12.0
> ## regress y x, vce(cluster firm)
> clm <- matrix(c(0.0044907, -0.00006474, -0.00006474, 0.00255993), nrow = 2)
> 
> ## logit via brl (https://economics.mit.edu/faculty/angrist/data1/mhe/brl)
> ## generate binary = (y > 0)
> ## brl binary x, cluster(firm) logit
> clb <- matrix(c(0.00358954,  0.00001531, 0.00001531, 0.00275766), nrow = 2)
> rownames(clm) <- colnames(clm) <- rownames(clb) <- colnames(clb) <- c("(Intercept)", "x")
> 
> all.equal(vcovCL(m, cluster = ~ firm), clm, tol = 1e-5)
[1] TRUE
> all.equal(vcovCL(b, cluster = ~ firm), clb, tol = 1e-5)
[1] TRUE
> 
> ## clustered HC2 for OLS and logit
> hc2m <- matrix(c(0.00449449, -0.00006593, -0.00006593, 0.00256824), nrow = 2)
> hc2b <- matrix(c(0.00359275,  0.000015, 0.000015, 0.00276326), nrow = 2)
> rownames(hc2m) <- colnames(hc2m) <- rownames(hc2b) <- colnames(hc2b) <- c("(Intercept)", "x")
> 
> all.equal(vcovCL(m, cluster = ~ firm, type = "HC2"), hc2m, tol = 1e-5)
[1] TRUE
> all.equal(vcovCL(b, cluster = ~ firm, type = "HC2"), hc2b, tol = 2e-4)
[1] "Mean relative difference: 0.0002815"
> 
> 
> ## more examples
> 
> data("InstInnovation", package = "sandwich")
> n <- glm(cites ~ institutions, data = InstInnovation, family = poisson)
> 
> vcovCL(n, cluster = ~ company, type = "HC0", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.158541   -2.178e-03
institutions   -0.002178    3.571e-05
> vcovCL(n, cluster = ~ company, type = "HC0", cadjust = FALSE)
             (Intercept) institutions
(Intercept)     0.158344   -2.176e-03
institutions   -0.002176    3.567e-05
> vcovCL(n, cluster = ~ company, type = "HC1", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.158567   -2.179e-03
institutions   -0.002179    3.572e-05
> vcovCL(n, cluster = ~ company, type = "HC1", cadjust = FALSE)
             (Intercept) institutions
(Intercept)     0.158369   -2.176e-03
institutions   -0.002176    3.567e-05
> vcovCL(n, cluster = ~ company, type = "HC2", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.158866   -0.0021838
institutions   -0.002184    0.0000358
> vcovCL(n, cluster = ~ company, type = "HC2", cadjust = FALSE)
             (Intercept) institutions
(Intercept)     0.158668   -2.181e-03
institutions   -0.002181    3.576e-05
> vcovCL(n, cluster = ~ company, type = "HC3", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.159391   -2.192e-03
institutions   -0.002192    3.594e-05
> vcovCL(n, cluster = ~ company, type = "HC3", cadjust = FALSE)
             (Intercept) institutions
(Intercept)     0.159193   -0.0021892
institutions   -0.002189    0.0000359
> 
> vcovCL(n, cluster = ~ company + year, type = "HC0", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.139420   -1.732e-03
institutions   -0.001732    3.753e-05
> vcovCL(n, cluster = ~ company + year, type = "HC0", cadjust = FALSE)
             (Intercept) institutions
(Intercept)     0.138228   -1.734e-03
institutions   -0.001734    3.651e-05
> vcovCL(n, cluster = ~ company + year, type = "HC1", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.139443   -1.732e-03
institutions   -0.001732    3.753e-05
> vcovCL(n, cluster = ~ company + year, type = "HC1", cadjust = FALSE)
             (Intercept) institutions
(Intercept)     0.138250   -1.734e-03
institutions   -0.001734    3.652e-05
> vcovCL(n, cluster = ~ company + year, type = "HC2", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.139697   -1.751e-03
institutions   -0.001751    3.815e-05
> vcovCL(n, cluster = ~ company + year, type = "HC2", cadjust = FALSE)
             (Intercept) institutions
(Intercept)     0.138509   -1.752e-03
institutions   -0.001752    3.708e-05
> vcovCL(n, cluster = ~ company + year, type = "HC3", cadjust = TRUE)
             (Intercept) institutions
(Intercept)     0.141639   -1.782e-03
institutions   -0.001782    4.029e-05
> vcovCL(n, cluster = ~ company + year, type = "HC3", cadjust = FALSE)
             (Intercept) institutions
(Intercept)      0.14029    -0.001780
institutions    -0.00178     0.000039
> 
> 
> o <- lm(log(cites) ~ institutions, data = InstInnovation, subset = cites > 0)
> 
> vcovCL(o, cluster = ~ company + year, type = "HC0", cadjust = TRUE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0230470   -2.844e-04
institutions  -0.0002844    1.524e-05
> vcovCL(o, cluster = ~ company + year, type = "HC0", cadjust = TRUE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0230458   -2.844e-04
institutions  -0.0002844    1.524e-05
> vcovCL(o, cluster = ~ company + year, type = "HC0", cadjust = FALSE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0216789   -0.0002725
institutions  -0.0002725    0.0000140
> vcovCL(o, cluster = ~ company + year, type = "HC0", cadjust = FALSE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0216789   -0.0002725
institutions  -0.0002725    0.0000140
> vcovCL(o, cluster = ~ company + year, type = "HC1", cadjust = TRUE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0230538   -2.845e-04
institutions  -0.0002845    1.524e-05
> vcovCL(o, cluster = ~ company + year, type = "HC1", cadjust = TRUE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0230516   -2.844e-04
institutions  -0.0002844    1.524e-05
> vcovCL(o, cluster = ~ company + year, type = "HC1", cadjust = FALSE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0216855   -0.0002726
institutions  -0.0002726    0.0000140
> vcovCL(o, cluster = ~ company + year, type = "HC1", cadjust = FALSE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0216843   -0.0002726
institutions  -0.0002726    0.0000140
> vcovCL(o, cluster = ~ company + year, type = "HC2", cadjust = TRUE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0239135   -2.926e-04
institutions  -0.0002926    1.517e-05
> vcovCL(o, cluster = ~ company + year, type = "HC2", cadjust = TRUE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0239124   -2.926e-04
institutions  -0.0002926    1.517e-05
> vcovCL(o, cluster = ~ company + year, type = "HC2", cadjust = FALSE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0224578   -2.799e-04
institutions  -0.0002799    1.394e-05
> vcovCL(o, cluster = ~ company + year, type = "HC2", cadjust = FALSE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0224578   -2.799e-04
institutions  -0.0002799    1.394e-05
> vcovCL(o, cluster = ~ company + year, type = "HC3", cadjust = TRUE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0266056   -0.0003167
institutions  -0.0003167    0.0000165
> vcovCL(o, cluster = ~ company + year, type = "HC3", cadjust = TRUE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0266044   -0.0003167
institutions  -0.0003167    0.0000165
> vcovCL(o, cluster = ~ company + year, type = "HC3", cadjust = FALSE, multi0 = TRUE)
             (Intercept) institutions
(Intercept)    0.0248614   -3.016e-04
institutions  -0.0003016    1.512e-05
> vcovCL(o, cluster = ~ company + year, type = "HC3", cadjust = FALSE, multi0 = FALSE)
             (Intercept) institutions
(Intercept)    0.0248614   -3.016e-04
institutions  -0.0003016    1.512e-05
> 
> 
> proc.time()
   user  system elapsed 
 84.457   0.083  84.537 
